# GitHub Actions è‡ªåŠ¨åŒ–éƒ¨ç½²é…ç½®æ–‡ä»¶
# ç”¨äºå°† Vue3 é¡¹ç›®è‡ªåŠ¨æ„å»ºå¹¶éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨
name: Deploy Vue3 App to Cloud Server

# è§¦å‘æ¡ä»¶ï¼šå½“æ¨é€åˆ° main åˆ†æ”¯æ—¶è‡ªåŠ¨æ‰§è¡Œ
on:
  push:
    branches:
      - main
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘éƒ¨ç½²
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

# ç¯å¢ƒå˜é‡é…ç½®
env:
  NODE_VERSION: '22.17.0'
  PNPM_VERSION: '10.12.4'
  BUILD_PATH: 'dist'

jobs:
  # æ„å»ºå’Œéƒ¨ç½²ä»»åŠ¡
  build-and-deploy:
    name: æ„å»ºå¹¶éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨
    runs-on: ubuntu-latest
    
    # è®¾ç½®è¶…æ—¶æ—¶é—´ï¼ˆ30åˆ†é’Ÿï¼‰
    timeout-minutes: 30
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¦ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          # è·å–å®Œæ•´çš„æäº¤å†å²ï¼Œç”¨äºç‰ˆæœ¬æ ‡è®°
          fetch-depth: 0

      # 2. è®¾ç½® pnpm åŒ…ç®¡ç†å™¨ï¼ˆå¿…é¡»åœ¨ Node.js ä¹‹å‰ï¼‰
      - name: ğŸ“‹ è®¾ç½® pnpm åŒ…ç®¡ç†å™¨
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      # 3. è®¾ç½® Node.js ç¯å¢ƒ
      - name: ğŸ”§ è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          # å¯ç”¨ä¾èµ–ç¼“å­˜ä»¥åŠ é€Ÿæ„å»º
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'

      # 4. éªŒè¯ pnpm å®‰è£…
      - name: âœ… éªŒè¯ pnpm å®‰è£…
        shell: bash
        run: |
          echo "éªŒè¯ pnpm å®‰è£…çŠ¶æ€..."
          which pnpm || {
            echo "âŒ é”™è¯¯: pnpm æœªæ‰¾åˆ°"
            echo "å°è¯•é‡æ–°å®‰è£… pnpm..."
            npm install -g pnpm@${{ env.PNPM_VERSION }}
          }
          
          echo "pnpm ç‰ˆæœ¬ä¿¡æ¯:"
          pnpm --version
          
          echo "pnpm å®‰è£…è·¯å¾„:"
          which pnpm

      # 5. è·å– pnpm ç¼“å­˜ç›®å½•
      - name: ğŸ—‚ï¸ è·å– pnpm ç¼“å­˜ç›®å½•
        shell: bash
        run: |
          echo "è·å– pnpm ç¼“å­˜ç›®å½•..."
          STORE_PATH=$(pnpm store path --silent)
          echo "pnpm ç¼“å­˜è·¯å¾„: $STORE_PATH"
          echo "STORE_PATH=$STORE_PATH" >> $GITHUB_ENV

      # 6. è®¾ç½® pnpm ç¼“å­˜
      - name: ğŸš€ è®¾ç½® pnpm ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      # 7. å®‰è£…é¡¹ç›®ä¾èµ–
      - name: ğŸ“¥ å®‰è£…é¡¹ç›®ä¾èµ–
        shell: bash
        run: |
          echo "å¼€å§‹å®‰è£…ä¾èµ–..."
          
          # æ£€æŸ¥ pnpm-lock.yaml æ˜¯å¦å­˜åœ¨
          if [ ! -f "pnpm-lock.yaml" ]; then
            echo "âš ï¸ è­¦å‘Š: pnpm-lock.yaml ä¸å­˜åœ¨ï¼Œå°†ç”Ÿæˆæ–°çš„é”å®šæ–‡ä»¶"
            pnpm install
          else
            echo "ä½¿ç”¨ pnpm-lock.yaml å®‰è£…ä¾èµ–"
            pnpm install --frozen-lockfile --prefer-offline
          fi
          
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
          echo "å·²å®‰è£…çš„åŒ…æ•°é‡: $(pnpm list --depth=0 2>/dev/null | wc -l)"

      # 8. æ„å»ºé¡¹ç›®
      - name: ğŸ—ï¸ æ„å»º Vue3 é¡¹ç›®
        shell: bash
        run: |
           echo "å¼€å§‹æ„å»ºé¡¹ç›®..."
           
           # æ£€æŸ¥æ„å»ºè„šæœ¬æ˜¯å¦å­˜åœ¨
           if ! pnpm run --if-present build --help 2>/dev/null | grep -q "build"; then
             # ä½¿ç”¨æ›´ç®€å•çš„æ–¹æ³•æ£€æŸ¥ package.json ä¸­æ˜¯å¦æœ‰ build è„šæœ¬
             if ! grep -q '"build"' package.json; then
               echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° build è„šæœ¬"
               echo "è¯·ç¡®ä¿ package.json ä¸­åŒ…å« build è„šæœ¬"
               exit 1
             fi
           fi
           
           # æ‰§è¡Œæ„å»º
           pnpm run build
           
           # æ£€æŸ¥æ„å»ºäº§ç‰©æ˜¯å¦å­˜åœ¨
           if [ ! -d "${{ env.BUILD_PATH }}" ]; then
             echo "âŒ é”™è¯¯: æ„å»ºç›®å½•ä¸å­˜åœ¨: ${{ env.BUILD_PATH }}"
             exit 1
           fi
           
           echo "âœ… é¡¹ç›®æ„å»ºå®Œæˆ"
           
           # æ˜¾ç¤ºæ„å»ºäº§ç‰©ä¿¡æ¯
           echo "æ„å»ºäº§ç‰©å¤§å°ï¼š"
           du -sh ${{ env.BUILD_PATH }}
           
           echo "æ„å»ºäº§ç‰©åˆ—è¡¨ï¼š"
           ls -la ${{ env.BUILD_PATH }}

      # 9. å‹ç¼©æ„å»ºäº§ç‰©ï¼ˆå‡å°‘ä¼ è¾“æ—¶é—´ï¼‰
      - name: ğŸ“¦ å‹ç¼©æ„å»ºäº§ç‰©
        shell: bash
        run: |
          echo "å‹ç¼©æ„å»ºäº§ç‰©..."
          
          # åˆ›å»ºå‹ç¼©åŒ…
          tar -czf build-${{ github.sha }}.tar.gz -C ${{ env.BUILD_PATH }} .
          
          echo "âœ… å‹ç¼©å®Œæˆ"
          echo "å‹ç¼©åŒ…å¤§å°ï¼š"
          ls -lh build-${{ github.sha }}.tar.gz
          
          # éªŒè¯å‹ç¼©åŒ…å†…å®¹
          echo "å‹ç¼©åŒ…å†…å®¹é¢„è§ˆï¼š"
          tar -tzf build-${{ github.sha }}.tar.gz | head -10

      # 10. éƒ¨ç½²æ–‡ä»¶åˆ°æœåŠ¡å™¨
      - name: ğŸš€ éƒ¨ç½²æ–‡ä»¶åˆ°äº‘æœåŠ¡å™¨
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          source: "build-${{ github.sha }}.tar.gz"
          target: "/tmp/"
          timeout: 300s

      # 11. åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œéƒ¨ç½²è„šæœ¬
      - name: ğŸ”„ æ‰§è¡ŒæœåŠ¡å™¨éƒ¨ç½²è„šæœ¬
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          timeout: 300s
          script: |
            set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
            
            echo "=== å¼€å§‹éƒ¨ç½²æµç¨‹ ==="
            
            # è®¾ç½®å˜é‡
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"
            BACKUP_PATH="${{ secrets.BACKUP_PATH || '/var/backups/webapp' }}"
            BUILD_FILE="/tmp/build-${{ github.sha }}.tar.gz"
            
            echo "éƒ¨ç½²è·¯å¾„: $DEPLOY_PATH"
            echo "å¤‡ä»½è·¯å¾„: $BACKUP_PATH"
            
            # åˆ›å»ºå¿…è¦çš„ç›®å½•
            sudo mkdir -p "$DEPLOY_PATH"
            sudo mkdir -p "$BACKUP_PATH"
            
            # å¤‡ä»½å½“å‰ç‰ˆæœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if [ -d "$DEPLOY_PATH" ] && [ "$(ls -A $DEPLOY_PATH)" ]; then
              echo "å¤‡ä»½å½“å‰ç‰ˆæœ¬..."
              BACKUP_NAME="backup-$(date +%Y%m%d-%H%M%S)"
              sudo tar -czf "$BACKUP_PATH/$BACKUP_NAME.tar.gz" -C "$DEPLOY_PATH" . || echo "å¤‡ä»½å¤±è´¥ï¼Œç»§ç»­éƒ¨ç½²"
              
              # ä¿ç•™æœ€è¿‘5ä¸ªå¤‡ä»½
              cd "$BACKUP_PATH"
              sudo ls -t backup-*.tar.gz 2>/dev/null | tail -n +6 | sudo xargs rm -f || true
            fi
            
            # æ¸…ç†æ—§æ–‡ä»¶
            echo "æ¸…ç†éƒ¨ç½²ç›®å½•..."
            sudo rm -rf "$DEPLOY_PATH"/*
            
            # è§£å‹æ–°ç‰ˆæœ¬
            echo "éƒ¨ç½²æ–°ç‰ˆæœ¬..."
            sudo tar -xzf "$BUILD_FILE" -C "$DEPLOY_PATH"
            
            # è®¾ç½®æ–‡ä»¶æƒé™
            echo "è®¾ç½®æ–‡ä»¶æƒé™..."
            sudo chown -R www-data:www-data "$DEPLOY_PATH" || sudo chown -R nginx:nginx "$DEPLOY_PATH" || echo "æƒé™è®¾ç½®å¯èƒ½éœ€è¦æ‰‹åŠ¨è°ƒæ•´"
            sudo chmod -R 755 "$DEPLOY_PATH"
            
            # é‡å¯ç›¸å…³æœåŠ¡ï¼ˆæ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ï¼‰
            echo "é‡å¯ Web æœåŠ¡..."
            sudo systemctl reload nginx || sudo service nginx reload || echo "Nginx é‡å¯å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥"
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
            rm -f "$BUILD_FILE"
            
            # å¥åº·æ£€æŸ¥ï¼ˆå¯é€‰ï¼‰
            echo "æ‰§è¡Œå¥åº·æ£€æŸ¥..."
            if [ ! -z "${{ secrets.HEALTH_CHECK_URL }}" ]; then
              sleep 5  # ç­‰å¾…æœåŠ¡å¯åŠ¨
              curl -f "${{ secrets.HEALTH_CHECK_URL }}" || echo "å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨éªŒè¯"
            fi
            
            echo "=== éƒ¨ç½²å®Œæˆ ==="
            echo "éƒ¨ç½²æ—¶é—´: $(date)"
            echo "Git æäº¤: ${{ github.sha }}"
            echo "éƒ¨ç½²è·¯å¾„: $DEPLOY_PATH"

      # 12. éƒ¨ç½²çŠ¶æ€é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
      - name: ğŸ“¢ å‘é€éƒ¨ç½²é€šçŸ¥
        if: always()
        shell: bash
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
            echo "ğŸ”— æäº¤: ${{ github.sha }}"
            echo "ğŸŒ åˆ†æ”¯: ${{ github.ref_name }}"
            echo "â° æ—¶é—´: $(date)"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
            echo "è¯·æ£€æŸ¥æ—¥å¿—å¹¶ä¿®å¤é—®é¢˜"
          fi
          
          # å¦‚æœé…ç½®äº†é€šçŸ¥ Webhookï¼Œå¯ä»¥åœ¨è¿™é‡Œå‘é€é€šçŸ¥
          # curl -X POST "${{ secrets.NOTIFICATION_WEBHOOK }}" -d '{"status": "${{ job.status }}", "commit": "${{ github.sha }}"}'