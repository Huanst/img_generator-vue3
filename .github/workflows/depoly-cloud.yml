name: Deploy to Server

on:
  push:
    branches:
      - main  # 当 main 分支有提交时触发

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 步骤 1: 检出代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 步骤 2: 设置 Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 步骤 3: 安装 pnpm
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: '9.8.0'

      # 步骤 4: 安装依赖
      - name: Install Dependencies
        run: pnpm install

      # 配置 apikey
      - name: Generate .env.local file
        run: |
          echo "VITE_SILICONFLOW_API_KEY=${{ secrets.API_KEY }}" >> .env.local
          # 如果你的 Vue 应用使用 VUE_APP_ 前缀
          # echo "VUE_APP_API_KEY=${{ secrets.API_KEY }}" >> .env.local

      # 步骤 5: 构建项目
      - name: Build
        run: pnpm build

      # 步骤 6: 配置 SSH
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      # 步骤 7: 清理并部署
      - name: Deploy
        env:
          SSH_AUTH_SOCK: /dev/null
        run: |
          # 清理目标目录（保留 .user.ini）
          ssh -i ~/.ssh/deploy_key deploy@${{ secrets.SERVER_HOST }} '
            cd /www/wwwroot/huanst.cn/ &&
            find . -not -name ".user.ini" -delete &&
            echo "Directory cleaned"
          '
          # 部署新文件
          scp -i ~/.ssh/deploy_key -r dist/* deploy@${{ secrets.SERVER_HOST }}:/www/wwwroot/huanst.cn/
