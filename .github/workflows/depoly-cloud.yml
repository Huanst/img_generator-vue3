# 你可以参考我的工作流配置
name: Deploy to Server

on:
  push:
    branches:
      - main  # 当 main 分支有提交时触发

jobs:
  deploy-server:
    runs-on: ubuntu-latest
    # 作业中的执行步骤
    steps:
      # 步骤 1: 检出代码
      - name: Checkout code
        uses: actions/checkout@v4 # 使用官方的 checkout Action，从仓库检出代码

      # 步骤 2: 设置 Node.js 环境
      - name: Setup Node.js
        uses: actions/setup-node@v4 # 使用官方的 Node.js Action
        with:
          node-version: '20' # 指定使用的 Node.js 版本为 20

      # 步骤 3: 安装 pnpm（Node.js 的包管理工具）
      - name: Setup pnpm
        uses: pnpm/action-setup@v2 # 使用 pnpm 的官方 GitHub Action
        with:
          version: '9.8.0' # 指定安装的 pnpm 版本为 9.8.0

      # 步骤 4: 安装依赖
      - name: Install Dependencies
        run: pnpm install # 使用 pnpm 安装项目依赖

      # 步骤 5: 构建项目
      - name: Build
        run: pnpm build # 执行项目的构建脚本

      # 步骤 6: 压缩构建文件
      - name: Compress build files
        run: |
          cd dist
          tar -czf ../dist.tar.gz ./*
          cd ..

      # 步骤 7: 部署到服务器
      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            # 确保目标目录存在并清理
            mkdir -p /www/wwwroot/huanst.cn
            rm -rf /www/wwwroot/huanst.cn/*
            
            echo "Target directory cleaned"

      # 步骤 8: 传输文件
      - name: Transfer files
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          source: "dist.tar.gz"
          target: "/www/wwwroot/huanst.cn"

      # 步骤 9: 解压文件并设置权限
      - name: Extract files and set permissions
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            cd /www/wwwroot/huanst.cn
            tar -xzf dist.tar.gz
            rm dist.tar.gz
            
            # 设置文件所有者为当前用户
            sudo chown -R $USER:$USER .
            # 设置目录权限为 755
            sudo find . -type d -exec chmod 755 {} \;
            # 设置文件权限为 644
            sudo find . -type f -exec chmod 644 {} \;
            
            echo "Deployment completed"